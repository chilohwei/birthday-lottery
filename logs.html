<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="src/favicon.ico">
    <title>æŠ½å¥–è®°å½•</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: block;
            padding: 30px;
            height: auto;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .back-button {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background-color: var(--primary-dark);
        }
        
        .log-container {
            opacity: 1;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .no-records {
            text-align: center;
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-bar input, .filter-bar select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
            flex-grow: 1;
        }
        
        .prize-stat {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            border-top: 3px solid var(--primary-color);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .log-table-container {
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background-color: white;
        }
        
        .timestamp-cell {
            white-space: nowrap;
        }
        
        .prize-cell {
            font-weight: bold;
        }
        
        .location-cell {
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .filter-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="log-container">
        <div class="header">
            <h1>å¹¸è¿å¤§æŠ½å¥– - æŠ½å¥–è®°å½•</h1>
            <a href="index.html" class="back-button">è¿”å›é¦–é¡µ</a>
        </div>
        
        <div class="prize-stat" id="prizeStats">
            <!-- å¥–å“ç»Ÿè®¡å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
        
        <div class="filter-bar">
            <input type="text" id="searchInput" placeholder="æœç´¢...">
            <select id="sortOrder">
                <option value="newest">æœ€æ–°ä¼˜å…ˆ</option>
                <option value="oldest">æœ€æ—©ä¼˜å…ˆ</option>
            </select>
        </div>
        
        <div class="log-table-container">
            <table id="logTable">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å¥–å“</th>
                        <th>ä½ç½®/IP</th>
                        <th>è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody id="logTableBody">
                    <!-- æ—¥å¿—æ¡ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
        
        <div id="noRecords" class="no-records" style="display: none;">
            <p>æš‚æ— æŠ½å¥–è®°å½•</p>
        </div>
        
        <div class="pagination" id="pagination">
            <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
    </div>
    
    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const logTableBody = document.getElementById('logTableBody');
            const noRecords = document.getElementById('noRecords');
            const prizeStats = document.getElementById('prizeStats');
            const sortOrder = document.getElementById('sortOrder');
            const searchInput = document.getElementById('searchInput');
            const pagination = document.getElementById('pagination');
            
            let allLogs = [];
            let filteredLogs = [];
            let currentPage = 1;
            const logsPerPage = 10;
            
            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
            function formatDateTime(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            
            // åŠ è½½æ—¥å¿—æ•°æ®
            async function loadLogs() {
                try {
                    // å°è¯•ä»APIè·å–æ—¥å¿—
                    const response = await fetch('api/prize-logs');
                    
                    if (response.ok) {
                        allLogs = await response.json();
                    } else {
                        // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ä»localStorageè·å–
                        console.warn('æ— æ³•ä»æœåŠ¡å™¨è·å–æ—¥å¿—ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–');
                        const localLogs = localStorage.getItem('prizeLog');
                        allLogs = localLogs ? JSON.parse(localLogs) : [];
                    }
                    
                    // é»˜è®¤æŒ‰ç…§æœ€æ–°æ’åº
                    allLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
                    
                    // è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    updateStats();
                    
                    // åº”ç”¨è¿‡æ»¤å’Œæ’åº
                    applyFiltersAndSort();
                } catch (error) {
                    console.error('åŠ è½½æ—¥å¿—æ—¶å‡ºé”™:', error);
                    noRecords.style.display = 'block';
                    noRecords.innerHTML = `<p>åŠ è½½æ—¥å¿—æ—¶å‡ºé”™: ${error.message}</p>`;
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            function updateStats() {
                if (!allLogs || allLogs.length === 0) {
                    prizeStats.innerHTML = `
                        <div class="stat-card">
                            <div>æ€»æŠ½å¥–æ¬¡æ•°</div>
                            <div class="stat-number">0</div>
                        </div>
                    `;
                    return;
                }
                
                // è®¡ç®—æ€»æ•°å’Œæ¯ä¸ªå¥–å“çš„æ•°é‡
                const totalCount = allLogs.length;
                
                // ç»Ÿè®¡å¥–å“åˆ†å¸ƒæƒ…å†µï¼ˆé€šç”¨æ–¹æ¡ˆï¼Œä¸ä¾èµ–é¢„å®šä¹‰çš„å¥–å“åˆ—è¡¨ï¼‰
                const prizeCounts = {};
                const prizeIcons = {};
                
                // ç»Ÿè®¡æ¯ä¸ªå¥–å“çš„æ•°é‡
                allLogs.forEach(log => {
                    if (!log.prize) return;
                    
                    if (!prizeCounts[log.prize]) {
                        prizeCounts[log.prize] = 0;
                        
                        // å°è¯•ä»å¥–å“ä¸­è·å–å›¾æ ‡
                        if (config && config.prizes && config.prizes[log.prize]) {
                            prizeIcons[log.prize] = config.prizes[log.prize].icon;
                        } else if (log.prizeIcon) {
                            prizeIcons[log.prize] = log.prizeIcon;
                        } else {
                            prizeIcons[log.prize] = 'ğŸ'; // é»˜è®¤å›¾æ ‡
                        }
                    }
                    
                    prizeCounts[log.prize]++;
                });
                
                // æ¸…ç©ºç»Ÿè®¡åŒºåŸŸ
                prizeStats.innerHTML = '';
                
                // æ·»åŠ æ€»æ•°ç»Ÿè®¡å¡ç‰‡
                const totalCard = document.createElement('div');
                totalCard.className = 'stat-card';
                totalCard.innerHTML = `
                    <div>æ€»æŠ½å¥–æ¬¡æ•°</div>
                    <div class="stat-number">${totalCount}</div>
                `;
                prizeStats.appendChild(totalCard);
                
                // ä¸ºæ¯ä¸ªå¥–å“æ·»åŠ ç»Ÿè®¡å¡ç‰‡
                Object.keys(prizeCounts).forEach(prize => {
                    const count = prizeCounts[prize];
                    const icon = prizeIcons[prize] || 'ğŸ';
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div>${icon} ${prize}</div>
                        <div class="stat-number">${count}</div>
                        <div>å…± ${Math.round((count / totalCount) * 100)}%</div>
                    `;
                    prizeStats.appendChild(card);
                });
            }
            
            // åº”ç”¨è¿‡æ»¤å’Œæ’åº
            function applyFiltersAndSort() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSort = sortOrder.value;
                
                // è¿‡æ»¤æ—¥å¿—
                filteredLogs = allLogs.filter(log => {
                    // æœç´¢è¿‡æ»¤
                    if (searchTerm) {
                        const prizeText = log.prizeText || log.prize || '';
                        const notification = log.notification || '';
                        const location = log.location || log.ip || '';
                        
                        return prizeText.toLowerCase().includes(searchTerm) || 
                               notification.toLowerCase().includes(searchTerm) ||
                               location.toLowerCase().includes(searchTerm);
                    }
                    
                    return true;
                });
                
                // åº”ç”¨æ’åº
                if (selectedSort === 'oldest') {
                    filteredLogs.sort((a, b) => new Date(a.time) - new Date(b.time));
                } else {
                    filteredLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
                }
                
                // æ›´æ–°è¡¨æ ¼
                updateTable();
            }
            
            // æ›´æ–°åˆ†é¡µ
            function updatePagination() {
                pagination.innerHTML = '';
                
                if (filteredLogs.length === 0) return;
                
                const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
                
                // æœ€å¤šæ˜¾ç¤º7ä¸ªé¡µç 
                const maxPagesToShow = 7;
                let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                
                // è°ƒæ•´èµ·å§‹é¡µ
                if (endPage - startPage + 1 < maxPagesToShow) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }
                
                // æ·»åŠ "ä¸Šä¸€é¡µ"æŒ‰é’®
                if (currentPage > 1) {
                    const prevLink = document.createElement('span');
                    prevLink.className = 'page-link';
                    prevLink.textContent = 'ä¸Šä¸€é¡µ';
                    prevLink.addEventListener('click', () => {
                        currentPage--;
                        updateTable();
                    });
                    pagination.appendChild(prevLink);
                }
                
                // æ·»åŠ é¡µç 
                for (let i = startPage; i <= endPage; i++) {
                    const pageLink = document.createElement('span');
                    pageLink.className = 'page-link';
                    if (i === currentPage) {
                        pageLink.classList.add('active');
                    }
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', () => {
                        currentPage = i;
                        updateTable();
                    });
                    pagination.appendChild(pageLink);
                }
                
                // æ·»åŠ "ä¸‹ä¸€é¡µ"æŒ‰é’®
                if (currentPage < totalPages) {
                    const nextLink = document.createElement('span');
                    nextLink.className = 'page-link';
                    nextLink.textContent = 'ä¸‹ä¸€é¡µ';
                    nextLink.addEventListener('click', () => {
                        currentPage++;
                        updateTable();
                    });
                    pagination.appendChild(nextLink);
                }
            }
            
            // æ›´æ–°è¡¨æ ¼
            function updateTable() {
                logTableBody.innerHTML = '';
                
                if (filteredLogs.length === 0) {
                    document.querySelector('.log-table-container').style.display = 'none';
                    pagination.style.display = 'none';
                    noRecords.style.display = 'block';
                    return;
                }
                
                document.querySelector('.log-table-container').style.display = 'block';
                noRecords.style.display = 'none';
                
                // è®¡ç®—å½“å‰é¡µçš„è®°å½•
                const startIdx = (currentPage - 1) * logsPerPage;
                const endIdx = Math.min(startIdx + logsPerPage, filteredLogs.length);
                const currentLogs = filteredLogs.slice(startIdx, endIdx);
                
                // æ·»åŠ è®°å½•åˆ°è¡¨æ ¼
                currentLogs.forEach(log => {
                    const row = document.createElement('tr');
                    
                    // æ—¶é—´åˆ—
                    const timeCell = document.createElement('td');
                    timeCell.className = 'timestamp-cell';
                    timeCell.textContent = formatDateTime(log.time);
                    row.appendChild(timeCell);
                    
                    // å¥–å“åˆ—
                    const prizeCell = document.createElement('td');
                    prizeCell.className = 'prize-cell';
                    
                    let prizeIcon = 'ğŸ'; // é»˜è®¤å›¾æ ‡
                    let prizeText = log.prizeText || log.prize || 'æœªçŸ¥å¥–å“';
                    
                    // å°è¯•ä»é…ç½®è·å–å¥–å“å›¾æ ‡
                    if (config && config.prizes && log.prize && config.prizes[log.prize]) {
                        prizeIcon = config.prizes[log.prize].icon;
                    } else if (log.prizeIcon) {
                        prizeIcon = log.prizeIcon;
                    }
                    
                    prizeCell.innerHTML = `${prizeIcon} ${prizeText}`;
                    row.appendChild(prizeCell);
                    
                    // ä½ç½®/IPåˆ—
                    const locationCell = document.createElement('td');
                    locationCell.className = 'location-cell';
                    locationCell.textContent = log.location || log.ip || 'æœªçŸ¥';
                    row.appendChild(locationCell);
                    
                    // è¯¦æƒ…åˆ—
                    const detailCell = document.createElement('td');
                    detailCell.textContent = log.notification || '';
                    row.appendChild(detailCell);
                    
                    logTableBody.appendChild(row);
                });
                
                // æ›´æ–°åˆ†é¡µ
                updatePagination();
            }
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            searchInput.addEventListener('input', () => {
                currentPage = 1;
                applyFiltersAndSort();
            });
            
            sortOrder.addEventListener('change', () => {
                currentPage = 1;
                applyFiltersAndSort();
            });
            
            // åˆå§‹åŒ–
            await loadLogs();
        });
    </script>
</body>
</html>